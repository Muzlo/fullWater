/**
 *	Waterfall瀑布流类   by: Jacky 
 *	API - http://www.jackyrao.com/archives/261
*/
(function(a){var b=function(d){var c={container_selector:"",col_space:10,cell_space:10,auto_imgsize:false,animate:false,animate_speed:500,fade_show:true,fade_speed:500,async_load:false,async_offset:0,asyncLoader:function(){},callback:function(){}};if(typeof(d.cell_selector)!=="string"||!a.trim(d.cell_selector)){return}this.settings=a.extend(c,d);this.cell_elms=a(this.settings.cell_selector);if(!this.cell_elms.length){return}this.container_elm=(a(this.settings.container_selector).length?a(this.settings.container_selector).first():this.cell_elms.first().parent());this.col_width=this.settings.col_width-0||this.cell_elms.first().outerWidth();this.settings.col_space=this.settings.col_space-0;this.settings.cell_space=this.settings.cell_space-0;this.init()};b.prototype={constructor:b,init:function(){this.container_elm.css("position","relative");this.compColNum();this.createColArr();this.locateCell();this.settings.callback();if(!this.settings.col_num){this.resizeEve()}if(this.settings.async_load){this.scrollEve()}},compColNum:function(){if(!this.settings.col_num){this.col_num=parseInt((this.container_elm.width()+this.settings.col_space)/(this.col_width+this.settings.col_space))}else{this.col_num=this.settings.col_num-0}},createColArr:function(){this.col_arr=new Array(this.col_num);for(var c=0;c<this.col_num;c++){this.col_arr[c]=0}},locateCell:function(){var c=this;this.cell_elms.each(function(e){a(this).css("position","absolute");if(e<c.col_num){var h=e%c.col_num?c.settings.col_space:0,g=(c.col_width+h)*e+"px",f="0px";c.col_arr[e]=a(this).outerHeight()}else{var d=c.compLowestIndex(),h=d%c.col_num?c.settings.col_space:0,g=(c.col_width+h)*d+"px",f=c.col_arr[d]+c.settings.cell_space+"px";c.col_arr[d]+=a(this).outerHeight()+c.settings.cell_space}if(c.settings.animate){a(this).animate({left:g,top:f},c.settings.animate_speed)}else{a(this).css({left:g,top:f})}});this.compContainerHeight();if(this.settings.async_load){this.compAsyncHeight()}},asyncInsertCell:function(){var c=this;var f=function(i){i.appendTo(c.container_elm);var j=c.compLowestIndex(),k=j%c.col_num?c.settings.col_space:0;i.css({position:"absolute",top:c.col_arr[j]+c.settings.cell_space+"px",left:(c.col_width+k)*j+"px"});c.col_arr[j]+=i.outerHeight()+c.settings.cell_space;if(c.settings.fade_show){i.fadeOut(0).fadeIn(c.settings.fade_speed)}};var h=function(){a.merge(c.cell_elms,c.async_cell_elms);c.compContainerHeight();c.compAsyncHeight();c.async_loading=false};var e=0,g=false,d=1;if(this.async_cell_elms.get(0).nodeName.toLowerCase()=="img"){e=this.async_cell_elms.length;g=true}else{e=this.async_cell_elms.find("img").length;g=false}this.async_cell_elms.each(function(){var i=g?a(this):a(this).find("img");if(c.settings.auto_imgsize&&i.length){var j=a(this);i.each(function(){var k=new Image();k.onload=function(){k.onreadystatechange=null;f(j);d++;if(d==e){h()}k=null};k.onreadystatechange=function(){if(k.readyState=="complete"){k.onload=null;f(j);d++;if(d==e){h()}k=null}};k.src=a(this).attr("src")})}else{f(a(this));if(d==e){h()}d++}})},compAsyncHeight:function(){this.async_height=this.container_elm.offset().top+this.col_arr[this.compLowestIndex()]-a(window).height()-this.settings.async_offset;if(this.settings.async_load){a(window).trigger("scroll.waterfall")}},compLowestIndex:function(){var d=this.col_arr[0],e=0;for(var c=1;c<this.col_arr.length;c++){if(this.col_arr[c]<d){d=this.col_arr[c];e=c}}return e},compContainerHeight:function(){var c=this.col_arr[0];for(var d=1;d<this.col_arr.length;d++){if(this.col_arr[d]>c){c=this.col_arr[d]}}this.container_elm.css("height",c+"px")},resizeEve:function(){var d=null,c=this;a(window).bind("resize.waterfall",function(){window.clearTimeout(d);d=window.setTimeout(function(){var e=c.col_num;c.compColNum();if(c.col_num!=e){c.rearrangeInit()}},200)})},rearrangeInit:function(){this.createColArr();this.locateCell()},scrollEve:function(){this.async_loading=false;var c=this;a(window).bind("scroll.waterfall",function(){if(a(this).scrollTop()>c.async_height){if(!c.async_loading){c.async_loading=true;c.settings.asyncLoader()}else{return}}}).trigger("scroll.waterfall")},load:function(d){if(!this.settings.async_load){return}var c=a(document.createElement("div")).html(d);this.async_cell_elms=c.find(this.settings.cell_selector);if(!this.async_cell_elms.length){return}else{this.asyncInsertCell()}},stop:function(){a(window).unbind("scroll.waterfall")}};window.Waterfall?"":window.Waterfall=b})(jQuery);